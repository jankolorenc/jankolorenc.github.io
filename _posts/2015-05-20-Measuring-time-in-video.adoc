= Measuring time in video

Recently I came across situation where it was necessary to measure time from captured video. It was during trampoline jumping event.
Jump air time is normally measured by photo diode positioned under bounce mat. Jumper crosses the infra red beam after landing till next bounce. Air time judge has to start measuring deice just before the first move.

image::trampoline_jumping.gif[title="Measuring air time", alt="Measuring air time"]

Sometimes measuring device does not work or air time judge doesn't start the device in right time. Jumping is recorded by video camera for later protest. When the air time measuring device doesn't give result, air time has to be measured from the recorded video.

Video was recorded using USB web camera connected to laptop, that encoded the video. Time measure from video was significantly shorter than time measured by air time measuring device. The problem was in laptop used as video encoder.

I created application that helps to measure time in video clip and made it available to download and try.

To make problem clear, next chapter describe video recording.

== Video recording

Video is recorded by taking pictures in regular interval. Number of pictures taken in second is called frames per second (FPS). The FPS information is stored together with captured pictures and video player uses FPS information to determine time when to show next picture. When video recorder doesn't keep FPS as promised, time in video is damaged and there is no way to identify the problem.
[image capturing image, FPS fail]

== Video encoding on laptop

As stated in previous chapter, it is necessary to keep FPS as precise as possible. Today's laptop include powerful processors that can encode video clip in shorter time than the clip lasts. Laptops run multitasking operating systems like MS Windows. There are several tasks running on laptop in the same time. Like video encoding, anti virus check, windows update, ... Try to run task manager to see running processes when laptop "does nothing". All running tasks share single processor or few processor cores. Operating system pretends that all tasks are running simultaneously by switching between them. Running task receive processor for a while and then the processor is provided to another task. Common operating systems does not guarantee time interval when the task receives processor again.

So it is hard to keep FPS on common operating system and encode live video even for powerful processors. This was our problem. Video encoder didn't keep FPS and time in video was skewed.

There are real time operating system that guarantee maximal time interval when the task receives processor again, but hey are not commonly installed on laptops.

Video recorder can encode live video without problem, because it does recording only.

== Take time from video

There is an application that can easily display time for each picture in recorded video clip and allowed easily to measure time. The problem was the application required AVI container. I saw the application for a while, I don't know name or creator. Hardware video recorders does not produce required AVI container so software video encoder running on laptop was used. There was idea to re-code video from video recorders to AVI container required by the measuring application, but video transcoders reduced FPS so time measuring was less precise. 

I decided to write similar time measuring application that can handle video clips directly from video recorders.

== Application requirements

 - GUI application to measure several time intervals in video clip.
 - User marks interval start and stop. Display total time as sum of measured intervals.
 - Save interval borders for later inspection.
 - Handle as much as possible video formats generated by video recorders.
 - Allow to move in video picture by picture forward and backward.
 - Use available libraries to reduce development time.
 - GUI design inspired by existing application.
 - Multiplatform at least for Windows and Linux (nice to have).

[img recordoing chart - record, take sd, measure]

== Selected libraries and programming language

 - FFMpeg - nice video library that can natively handle large amount of video format. Allows to move forward and backward in video picture by picture. FFMpeg computes decoding timestamp for each picture. It includes decoding buffer and decodes pictures necessary to decode required picture itself.
 - QT library - nice multiplatform GUI library with designer.
 - C/C++ to glue FFMpeg with QT. There are wrappers over FFMpeg and QT for higher level languages, but rather incomplete, so backward moving picture by picture is difficult.

== Decoding pictures using FFMpeg

Video contain complete pictures called I-frames. Other pictures between I-frames are stored as "difference" to previous I-frame (P-frames) and next I-frame (B-frames). When decoding, jump to nearest previous I-frame and decode sequentially until required picture is reached. Going sequentilly backwards is not natively possible.

Jumping is in time units that makes harder to estimate jump length. Number of I-frames per time unit (GOP) is not always available. FFMpeg assign decoding timestamp to each picture and automatically decodes all pictures necessary to decode required picture when going forward. Pictures are not always stored in the same order as they are captured.

Decoded pictures are saved to buffer to reduce jumping when going several pictures backward. The buffer will take some RAM.
